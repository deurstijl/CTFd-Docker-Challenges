{% extends 'admin/base.html' %}
{% block content %}
<div class="bg-light p-4 mb-4 rounded">
  <div class="container">
    <h1 class="text-center">Docker Status</h1>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-10 offset-md-1">
      {% for error in errors %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <span class="visually-hidden">Error:</span>
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}

      {% if dockers %}
      <table id="dockers" class="table table-striped">
        <thead>
          <tr>
            <th width="10px" class="text-center">ID</th>
            <th class="text-start sort-col">{% if dockers[0].team_id %}Team{% else %}User{% endif %}</th>
            <th class="text-start sort-col">Docker Image</th>
            <th class="text-start sort-col">Challenge</th>
            <th class="text-start sort-col">Instance ID</th>
            <th class="text-start sort-col">Start Time</th>
            <th class="text-start">Revoke</th>
          </tr>
        </thead>
        <tbody>
          {% for docker in dockers %}
          <tr id="tr_{{ docker.instance_id }}" name="{{ docker.id }}">
            <td class="text-center">{{ docker.id }}</td>
            {% if docker.team_id %}
            <td class="text-start">{{ docker.team_id | safe }}</td>
            {% else %}
            <td class="text-start">{{ docker.user_id | safe }}</td>
            {% endif %}
            <td class="text-start text-nowrap">{{ docker.docker_image }}</td>
            <td class="text-start text-nowrap">{{ docker.challenge }}</td>
            <td class="text-start">{{ docker.instance_id | truncate(15) }}</td>
            <td class="text-start text-nowrap">{{ docker.timestamp | datetimeformat }}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-danger" data-instance-id="{{ docker.instance_id }}" data-all="false">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="text-center">
        <button class="btn btn-danger" id="nuke-all" data-all="true">Nuke All Containers</button>
      </div>
      {% else %}
      <h3 class="text-center">No Docker Containers Active</h3>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script {% if csp_nonce %} nonce="{{ csp_nonce }}" {% endif %}>
  document.addEventListener("DOMContentLoaded", () => {
    function checkNukeContainer(instance, all) {
      if (confirm("Are You Sure You want to do this?")){
        nukeContainer(instance, all)
      };
    }

    function nukeContainer(instance, all) {
      fetch(`/api/v1/nuke?container=${encodeURIComponent(instance)}&all=${encodeURIComponent(all)}`, {
        method: 'GET',
        credentials: 'same-origin'
      })
        .then(response => {
          if (response.ok) {
            if (all === true) {
              const scriptRoot = document.body.dataset.scriptRoot || '';
              window.location.href = `${scriptRoot}/admin/docker_status`;
            } else {
              const row = document.getElementById(`tr_${instance}`);
              if (row) row.style.display = 'none';
            }
          } else {
            throw new Error("Request failed");
          }
        })
        .catch(() => {
          alert("Error when Deleting Docker Container");
        });
    }

    document.querySelectorAll('button[data-instance-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const instance = btn.getAttribute('data-instance-id');
        checkNukeContainer(instance, false);
      });
    });

    const nukeAllBtn = document.getElementById('nuke-all');
    if (nukeAllBtn) {
      nukeAllBtn.addEventListener('click', () => {
        checkNukeContainer(null, true);
      });
    }
  });

</script>
{% endblock scripts %}
